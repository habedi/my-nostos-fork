# expect: 0
# 1000 processes increment a shared counter using atomic self-updating pattern

mvar count: Int = 0

# Atomic increment using self-updating pattern
increment() = {
    count = count + 1
}

spawn_workers(parent, n: Int) = if n <= 0 then () else {
    spawn { increment(); parent <- true }
    spawn_workers(parent, n - 1)
}

wait_all(n: Int) = if n <= 0 then () else {
    receive { _ -> wait_all(n - 1) }
}

main() = {
    me = self()

    # Verify initial value
    assert_eq(0, count)

    # Spawn 1000 workers
    spawn_workers(me, 1000)
    wait_all(1000)

    # Verify final count is exactly 1000
    assert_eq(1000, count)

    0
}
