# expect_error: reads mvar `queue_size` and later writes it
# Tests that compare-and-set pattern is detected in consume function.
# The pattern "if queue_size > 0 then { queue_size = ... }" has race conditions.

mvar queue_size: Int = 0

# Dangerous pattern: reads queue_size in condition, writes in branch
consume() = {
    if queue_size > 0 then {
        queue_size = queue_size - 1
        true
    } else {
        false
    }
}

main() = 0
