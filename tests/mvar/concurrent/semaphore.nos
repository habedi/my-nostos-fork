# expect: 0
# Tests atomic self-updating mvar operations under concurrency
# (safe pattern: mvar = mvar + 1)

mvar acquired_total: Int = 0
mvar released_total: Int = 0

# Safe: purely self-updating patterns
acquire() = {
    acquired_total = acquired_total + 1
    ()
}

release() = {
    released_total = released_total + 1
    ()
}

do_acquire_release(n) = if n <= 0 then () else {
    acquire()
    release()
    do_acquire_release(n - 1)
}

worker(parent, n) = {
    do_acquire_release(n)
    parent <- true
}

main() = {
    me = self()

    # Spawn workers that acquire and release
    spawn { worker(me, 10) }
    spawn { worker(me, 10) }
    spawn { worker(me, 10) }
    spawn { worker(me, 10) }

    # Wait for all
    receive { _ -> () }
    receive { _ -> () }
    receive { _ -> () }
    receive { _ -> () }

    # Total acquired should equal total released = 40
    assert_eq(40, acquired_total)
    assert_eq(40, released_total)
    0
}
