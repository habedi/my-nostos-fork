# expect: 0
# Tests concurrent min tracking using mvar.update for atomic compare-and-swap

mvar min_val: Int = 999999

# Safe pattern using update - atomically updates to min of current and n
update_min(n) = min_val.update(x => if n < x then n else x)

# Worker that submits values
worker(parent, values) = {
    values.each(v => update_min(v))
    parent <- "done"
}

main() = {
    me = self()

    # Multiple workers submitting different values
    spawn { worker(me, [50, 30, 70]) }
    spawn { worker(me, [20, 80, 40]) }
    spawn { worker(me, [90, 10, 60]) }

    # Wait for workers
    receive { _ -> () }
    receive { _ -> () }
    receive { _ -> () }

    # The minimum should be 10
    assert_eq(10, min_val)
    0
}
