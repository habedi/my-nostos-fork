# expect: 102334155
# Memoization decorator - demonstrates template-based caching
# The @memoize decorator wraps fib with automatic cache lookup

mvar fibCache: Map[Int, Int] = %{}

template memoize(fn) = quote {
    if Map.contains(fibCache, ~toVar(fn.params[0].name)) {
        Map.get(fibCache, ~toVar(fn.params[0].name))
    } else {
        result = ~fn.body
        fibCache.update(c => c.insert(~toVar(fn.params[0].name), result))
        result
    }
}

@memoize
fib(n: Int) -> Int = if n < 2 { n } else { fib(n - 1) + fib(n - 2) }

main() = fib(40)
